name: Auto Publish Website # 自动部署的名称
on:
  push:
    branches:
      - main
permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-22.04
    steps:

      -
        name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: isntall git
        run: sudo apt install --yes git

      - name: git global
        run: |
          sudo git config --global --add safe.directory '*'
          sudo git tag v999.999.999-alpha
      -
        name: Fetch all tags
        run: sudo git fetch --force --tags
        
      - name: Get version
        id: get_version
        # run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}
        run: echo "VERSION=$(git describe --abbrev=0 --tags | awk -F- '{print $1}')" >> $GITHUB_ENV

      - name: show version
        id: show_version
        # run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}
        run: echo ${{env.VERSION}}

      -
        name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.19
      -
        name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v2
        with:
          # either 'goreleaser' (default) or 'goreleaser-pro'
          distribution: goreleaser
          version: latest
          args: release --rm-dist --snapshot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Your GoReleaser Pro key, if you are using the 'goreleaser-pro' distribution
          # GORELEASER_KEY: ${{ secrets.GORELEASER_KEY }}
          # sshpass -p "${{ secrets.ssh_password }}" scp -r -o StrictHostKeyChecking=no -P ${{ secrets.ssh_port }} ./dist/*.gz root@${{ secrets.ssh_ip }}:/var/www/download
      - name: ssh and copy 🚀
        uses: cross-the-world/ssh-scp-ssh-pipelines@latest # 因为构建之后，需要把代码上传到服务器上，所以需要连接到ssh，并且做一个安全拷贝(security copy)操作
        env:
           WELCOME: "ssh scp ssh pipelines"
           LASTSSH: "Doing something after copying"
        with:
          host: 192.168.2.115
          user: root
          pass: casaos
          port: 22
          connect_timeout: 10s
          first_ssh: |

          scp: |
            './dist/*.gz' => /DATA/testssh
          last_ssh: |
            cd /DATA/testssh           
            ls
      - name: send message
        run: |
          curl -X POST -H "Content-Type: application/json" -d '{"msg_type":"text","content":{"text":"CasaOS测试环境已更新"}}' https://open.feishu.cn/open-apis/bot/v2/hook/21980b82-3c60-4636-b6d2-04a7822a0185
