name: Auto Publish Website # 自动部署的名称
on:
  push:
    branches:
      - main
permissions:
  contents: write

jobs:
  goreleaser:
    runs-on: ubuntu-22.04
    steps:

      -
        name: Checkout
        uses: actions/checkout@v2
        with:
          fetch-depth: 0

      - name: isntall git
        run: sudo apt install --yes git

      - name: git global
        run: |
          sudo git config --global --add safe.directory '*'
          sudo git tag v999.999.999-alpha
      -
        name: Fetch all tags
        run: sudo git fetch --force --tags
        
      - name: Get version
        id: get_version
        # run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}
        run: echo "VERSION=$(git describe --abbrev=0 --tags | awk -F- '{print $1}')" >> $GITHUB_ENV

      - name: show version
        id: show_version
        # run: echo ::set-output name=VERSION::${GITHUB_REF/refs\/tags\//}
        run: echo ${{env.VERSION}}

      -
        name: Set up Go
        uses: actions/setup-go@v2
        with:
          go-version: 1.19
      -
        name: Run GoReleaser
        uses: goreleaser/goreleaser-action@v2
        with:
          # either 'goreleaser' (default) or 'goreleaser-pro'
          distribution: goreleaser
          version: latest
          args: release --rm-dist --snapshot
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          # Your GoReleaser Pro key, if you are using the 'goreleaser-pro' distribution
          # GORELEASER_KEY: ${{ secrets.GORELEASER_KEY }}
          # sshpass -p "${{ secrets.ssh_password }}" scp -r -o StrictHostKeyChecking=no -P ${{ secrets.ssh_port }} ./dist/*.gz root@${{ secrets.ssh_ip }}:/var/www/download

        # 部署到服务器
      - name: Deploy
        uses: easingthemes/ssh-deploy@v2.1.5
        env:
            SSH_PRIVATE_KEY: ${{ secrets.BRUCE_SSH_KEY }} # 服务器的key
            ARGS: '-rltgoDzvO --delete'  #(optional, default '-rltgoDzvO')
            SOURCE: ./dist/*.gz # 这是要复制到服务器的文件夹名称
            REMOTE_HOST: iw.pfe.ink:34569 # 你的服务器公网地址
            REMOTE_USER: root # 服务器登录用户名
            TARGET: /DATA/testssh # 放到的目标地址
      - name: send message
        run: |
          curl -X POST -H "Content-Type: application/json" -d '{"msg_type":"text","content":{"text":"CasaOS测试环境已更新"}}' https://open.feishu.cn/open-apis/bot/v2/hook/21980b82-3c60-4636-b6d2-04a7822a0185
